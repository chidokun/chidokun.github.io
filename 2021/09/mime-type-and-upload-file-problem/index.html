<!DOCTYPE html>
<html lang="vi">
  <head>
    
    <script type="application/ld+json">

{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Bàn về MIME Type và Bài toán Nhận dạng File type khi upload",
  
  "image": "https://chidokun.github.io/thumbnails/mime.png",
  
  "datePublished": "2021-09-29T22:30:00+07:00",
  "dateModified": "2021-09-29T22:30:00+07:00",
  "author": {
    "@type": "Person",
    "name": "Nguyễn Tuấn",
    
    "image": "https://www.gravatar.com/avatar/e09926cb6ae66048297c59c891a02e50"
    
  },
  "mainEntityOfPage": { 
    "@type": "WebPage",
    "@id": "https:\/\/chidokun.github.io\/2021\/09\/mime-type-and-upload-file-problem\/" 
  },
  "publisher": {
    "@type": "Organization",
    "name": "Nguyễn Tuấn's Blog",
    
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.gravatar.com/avatar/e09926cb6ae66048297c59c891a02e50"
    }
    
  },
  "description": "Câu chuyện bắt đầu trong một dự án nọ, có một yêu cầu được đưa ra phải phát triển tính năng cho phép người quản trị upload một file text chứa các từ bị cấm để hệ thống cập nhật config phục vụ việc kiểm tra real-time nội dung người dùng gửi lên. Yêu cầu chỉ được phép upload lên file text theo một định dạng nhất định.",
  "keywords": ["mime type, file type, mime type detection, upload", "development, programming, chidokun, lập trình"]
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.87.0 with theme Tranquilpeak 0.5.0-BETA">
<meta name="author" content="Nguyễn Tuấn">
<meta name="keywords" content="mime type, file type, mime type detection, upload, development, programming, chidokun, lập trình">
<meta name="description" content="Câu chuyện bắt đầu trong một dự án nọ, có một yêu cầu được đưa ra phải phát triển tính năng cho phép người quản trị upload một file text chứa các từ bị cấm để hệ thống cập nhật config phục vụ việc kiểm tra real-time nội dung người dùng gửi lên. Yêu cầu chỉ được phép upload lên file text theo một định dạng nhất định.">


<meta property="og:description" content="Câu chuyện bắt đầu trong một dự án nọ, có một yêu cầu được đưa ra phải phát triển tính năng cho phép người quản trị upload một file text chứa các từ bị cấm để hệ thống cập nhật config phục vụ việc kiểm tra real-time nội dung người dùng gửi lên. Yêu cầu chỉ được phép upload lên file text theo một định dạng nhất định.">
<meta property="og:type" content="article">
<meta property="og:title" content="Bàn về MIME Type và Bài toán Nhận dạng File type khi upload">
<meta name="twitter:title" content="Bàn về MIME Type và Bài toán Nhận dạng File type khi upload">
<meta property="og:url" content="https://chidokun.github.io/2021/09/mime-type-and-upload-file-problem/">
<meta property="twitter:url" content="https://chidokun.github.io/2021/09/mime-type-and-upload-file-problem/">
<meta property="og:site_name" content="Nguyễn Tuấn&#39;s Blog">
<meta property="og:description" content="Câu chuyện bắt đầu trong một dự án nọ, có một yêu cầu được đưa ra phải phát triển tính năng cho phép người quản trị upload một file text chứa các từ bị cấm để hệ thống cập nhật config phục vụ việc kiểm tra real-time nội dung người dùng gửi lên. Yêu cầu chỉ được phép upload lên file text theo một định dạng nhất định.">
<meta name="twitter:description" content="Câu chuyện bắt đầu trong một dự án nọ, có một yêu cầu được đưa ra phải phát triển tính năng cho phép người quản trị upload một file text chứa các từ bị cấm để hệ thống cập nhật config phục vụ việc kiểm tra real-time nội dung người dùng gửi lên. Yêu cầu chỉ được phép upload lên file text theo một định dạng nhất định.">
<meta property="og:locale" content="vi">

  
    <meta property="article:published_time" content="2021-09-29T22:30:00">
  
  
    <meta property="article:modified_time" content="2021-09-29T22:30:00">
  
  
  
    
      <meta property="article:section" content="Lập trình">
    
      <meta property="article:section" content="Backend">
    
  
  
    
      <meta property="article:tag" content="backend">
    
  


<meta name="twitter:card" content="summary">







  <meta property="og:image" content="https://www.gravatar.com/avatar/e09926cb6ae66048297c59c891a02e50?s=640">
  <meta property="twitter:image" content="https://www.gravatar.com/avatar/e09926cb6ae66048297c59c891a02e50?s=640">





  <meta property="og:image" content="https://chidokun.github.io/thumbnails/mime.png">
  <meta property="twitter:image" content="https://chidokun.github.io/thumbnails/mime.png">


    <title>Bàn về MIME Type và Bài toán Nhận dạng File type khi upload</title>

    <link rel="icon" href="https://chidokun.github.io/favicon.png">
    

    

    <link rel="canonical" href="https://chidokun.github.io/2021/09/mime-type-and-upload-file-problem/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://chidokun.github.io/css/style-x4v5aep1xln8tw4u8b4utrzzm45rcnnq6emr4myqn5eka2yri56y1t7q.min.css" />
    
    
      
        <link rel="stylesheet"  crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei">
      
    
      
        <link rel="stylesheet"  href="https://chidokun.github.io/styles/styles.css">
      
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-64965138-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
    
    <meta name="google-site-verification" content="MgXdDXZwDhcwwTzczA6YhQBynidGFAQUBd7PKu2ubfI" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,700;1,900&subset=cyrillic,cyrillic-ext,latin-ext&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;0,800;1,300;1,400;1,600;1,700;1,800&display=swap" rel="stylesheet">
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://chidokun.github.io/" aria-label="Tới trang chủ">Nguyễn Tuấn&#39;s Blog</a>
  </div>
  
    
      <a class="header-right-icon st-search-show-outputs"
         href="https://chidokun.github.io/#search" aria-label="Mở liên kết: /#search">
    
    
      <i class="fa fa-lg fa-search"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://chidokun.github.io/#about" aria-label="Tìm hiểu thêm về tác giả">
          <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/e09926cb6ae66048297c59c891a02e50?s=110" alt="Ảnh đại diện" />
        </a>
        <h4 class="sidebar-profile-name">Nguyễn Tuấn</h4>
        
          <h5 class="sidebar-profile-bio">A guy with passionate at the code</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://chidokun.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Trang chủ</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://chidokun.github.io/categories/l%E1%BA%ADp-tr%C3%ACnh/" title="Lập trình">
    
      <i class="sidebar-button-icon far fa-lg fa-code" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Lập trình</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://chidokun.github.io/categories/d%E1%BB%AF-li%E1%BB%87u/" title="Dữ liệu">
    
      <i class="sidebar-button-icon fa fa-lg fa-database" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Dữ liệu</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://chidokun.github.io/categories/cu%E1%BB%99c-s%E1%BB%91ng/" title="Cuộc sống">
    
      <i class="sidebar-button-icon fab fa-lg fa-pagelines" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Cuộc sống</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://chidokun.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Danh mục</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://chidokun.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Thẻ thông tin</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://chidokun.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Lưu trữ</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://chidokun.github.io/#about" title="About">
    
      <i class="sidebar-button-icon fa fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Thông tin</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/chidokun" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://chidokun.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="5"
        class="
               hasCoverMetaIn
               ">
        <article class="post">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Bàn về MIME Type và Bài toán Nhận dạng File type khi upload
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2021-09-29T22:30:00&#43;07:00">
        
  
  
  
  
    29 tháng 9 2021
  

      </time>
    
    
  
  
    <span>mục</span>
    
      <a class="category-link" href="https://chidokun.github.io/categories/l%e1%ba%adp-tr%c3%acnh">Lập trình</a>, 
    
      <a class="category-link" href="https://chidokun.github.io/categories/backend">Backend</a>
    
  

  </div>

  <div>
  <div class="fb-like" 
    data-href="https://chidokun.github.io/2021/09/mime-type-and-upload-file-problem/" 
    data-width="" 
    data-layout="button_count" 
    data-action="like" 
    data-size="large" 
    data-share="false"></div>
</div>
</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <h1 id="table-of-contents">Mục lục</h1>
<nav id="TableOfContents">
  <ul>
    <li><a href="#mở-đầu">Mở đầu</a></li>
    <li><a href="#bắt-tay-nào">Bắt tay nào!</a></li>
    <li><a href="#xác-thực-kiểu-file-ở-phía-backend">Xác thực kiểu File ở phía Backend</a>
      <ul>
        <li><a href="#dựa-vào-mime-type-được-xác-định-bởi-user-agent">Dựa vào MIME Type được xác định bởi User-agent</a></li>
        <li><a href="#mime-type-và-một-số-cách-xác-định-file-type">MIME Type và một số cách xác định file type</a></li>
        <li><a href="#dùng-apache-tika-để-xác-định-mime-type">Dùng Apache Tika để xác định MIME Type</a></li>
      </ul>
    </li>
    <li><a href="#tldr">TL;DR</a></li>
  </ul>
</nav>

<h1 id="mở-đầu">Mở đầu</h1>
<p>Câu chuyện bắt đầu trong một dự án nọ, có một yêu cầu được đưa ra phải phát triển tính năng cho phép người quản trị upload một file text chứa các từ bị cấm. Hệ thống sau đó sẽ cập nhật config phục vụ việc kiểm tra real-time nội dung người dùng gửi lên. Yêu cầu chỉ được phép upload lên file text theo một định dạng nhất định.</p>
<p>Để chặn không cho người dùng upload những file khác ngoài file text, ta có thể được thực hiện trên frontend.</p>
<pre><code class="language-html">&lt;input type=&quot;file&quot; accept=&quot;text/plain&quot; /&gt;
</code></pre>
<p>Lúc này người dùng chỉ có thể chọn file text trong cửa sổ duyệt file.</p>
<p>Tuy nhiên, để đảm bảo an toàn cho hệ thống, chỉ chặn người dùng trên giao diện là chưa đủ, cần phải xác thực lại file được upload lên ở phía backend xem có phải người dùng đã tải lên một file text hay không. <em><span class="highlight-text green">Bài toán chúng ta cần giải quyết là xác định kiểu của file được người dùng upload lên</span></em>.</p>
<h1 id="bắt-tay-nào">Bắt tay nào!</h1>
<p>Để minh họa cho bài toán trên, chúng ta sẽ xây dựng hệ thống minh họa với phần giao diện sử dụng React.js và backend sử dụng Java/Spring Boot.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="https://chidokun.github.io/images/post/software/mime-type-and-upload-file-problem/1.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://chidokun.github.io/images/post/software/mime-type-and-upload-file-problem/1.png" style="width: 80%;">
  
    </a>
  
  
</div>

<p>Giao diện của chúng ta khá đơn giản, gồm một <code>input[type=file]</code> và một <code>button</code> để upload file được chọn. Khi chọn một file, giao diện sẽ hiển thị MIME Type mà trình duyệt xác định. Sau khi upload file, hệ thống sẽ trả về MIME type mà phía backend xác định. Toàn bộ source code có thể xem ở <a href="https://github.com/chidokun/mime-type-upload-example">đây</a>.</p>
<p>Đồng thời chuẩn bị một số file để test xem hệ thống có xác định đúng hay không.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="https://chidokun.github.io/images/post/software/mime-type-and-upload-file-problem/2.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://chidokun.github.io/images/post/software/mime-type-and-upload-file-problem/2.png" style="width: 100%;">
  
    </a>
  
  
</div>

<p>Chuẩn bị 3 file có định dạng đúng với extension, sau đó copy 3 file này và đổi tên lại:</p>
<ul>
<li>real.png -&gt; fake.txt</li>
<li>real.jpg -&gt; fake.zip</li>
<li>real.svg -&gt; fake.docx</li>
</ul>
<h1 id="xác-thực-kiểu-file-ở-phía-backend">Xác thực kiểu File ở phía Backend</h1>
<p>Hệ thống backend trong dự án được viết bằng Java sử dụng Spring Boot. Một controller được cài đặt để nhận request upload từ phía người dùng.</p>

  
    
  
  
    
  
  
  


<figure class="highlight java language-java">
  <figcaption>
    
      <span>UploadController.java</span>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-java java"><code class="java">@Slf4j
@RestController
public class UploadController {

    @PostMapping(path = &#34;/check-file-type&#34;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity&lt;Response&gt; checkFileType(@RequestPart MultipartFile file) {
        // to be implemented
    }
}</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>

<p>Và một <code>Response</code> để trả kết quả về cho người dùng.</p>

  
    
  
  
    
  
  
  


<figure class="highlight java language-java">
  <figcaption>
    
      <span>Response.java</span>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-java java"><code class="java">@Data
@NoArgsConstructor
@AllArgsConstructor
public class Response {
    private int status;
    private String message;
    private String mimeType;

    public Response(String mimeType) {
        this.status = HttpStatus.OK.value();
        this.message = &#34;Successful&#34;;
        this.mimeType = mimeType;
    }
}</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>

<h2 id="dựa-vào-mime-type-được-xác-định-bởi-user-agent">Dựa vào MIME Type được xác định bởi User-agent</h2>
<p>Khi chọn một file từ <code>input[type=file]</code>, kiểu file đã được trình duyệt (user-agent) xác định theo MIME type và truyền xuống backend thông qua request header <code>Content-Type</code>. Vì vậy, class <code>MultipartFile</code> trong tham số đầu vào của controller đã có thông tin về kiểu của file.</p>
<p>Đến đây có thể sử dụng <code>getContentType()</code> để xác định kiểu file dựa trên MIME Type.</p>
<pre><code class="language-java">@PostMapping(path = &quot;/check-file-type&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
public ResponseEntity&lt;Response&gt; checkFileType(@RequestPart MultipartFile file) {
    String mimeType = file.getContentType();
    return ResponseEntity.ok(new Response(mimeType));
}
</code></pre>
<p>Cùng test lại mới các file test đã chuẩn bị trước.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="https://chidokun.github.io/images/post/software/mime-type-and-upload-file-problem/3.png" title="Kết quả test với real.png và fake.zip" data-fancybox-group="">
  
    <img class="fig-img" src="https://chidokun.github.io/images/post/software/mime-type-and-upload-file-problem/3.png" style="width: 100%;" alt="Kết quả test với real.png và fake.zip">
  
    </a>
  
   
    <span class="caption">Kết quả test với real.png và fake.zip</span>
  
</div>

<p>Trường hợp file <code>real.png</code>, user-agent đã xác định đúng MIME type thông qua extension <code>.png</code>. Nhưng với file <code>fake.zip</code>, user-agent không thể xác định đúng loại file của nó là JPG mà xác định thông qua extension <code>.zip</code>. Do đó, việc dựa trên MIME type do client xác định tiềm ẩn nhiều rủi ro khi người dùng có thể cố tình đổi tên và extension của file.</p>
<p>Mỗi loại file có đặc tả khác nhau và được lưu trữ cấu trúc khác nhau, vì vậy muốn xác định chính xác kiểu của file thì cần dựa vào nội dung bên trong của file đó.</p>
<h2 id="mime-type-và-một-số-cách-xác-định-file-type">MIME Type và một số cách xác định file type</h2>
<p><strong>MIME type</strong> (<em>Multipurpose Internet Mail Extensions</em>) là một tiêu chuẩn xác định bản chất và định dạng của tài liệu, file hoặc một tập hợp các byte. Nó được định nghĩa và chuẩn hóa trong <a href="https://datatracker.ietf.org/doc/html/rfc6838">RFC 6838</a> của IETF.</p>
<p>Cấu trúc của MIME type gồm có <em>type</em> và <em>subtype</em>:</p>
<pre><code>type/subtype
</code></pre>
<p><em>Ví dụ</em>: <code>text/plain</code>, <code>application/zip</code>, &hellip;</p>
<p>Trong đó:</p>
<ul>
<li><strong>Type</strong> là danh mục chung mà loại dữ liệu thuộc về, chẳng hạn như <code>video</code> hoặc <code>text</code>.</li>
<li><strong>Subtype</strong> xác định loại dữ liệu chính xác của kiểu dữ liệu đó được phân loại. Ví dụ: Với type <code>text</code>, ta có thể có các subtype như <code>plain</code> (text thuần), <code>html</code> (HTML source code), hoặc <code>calendar</code> (định dạng <code>.ics</code> của iCalendar).</li>
</ul>
<p>Nói chung, <em><span class="highlight-text green">MIME Type là một cái tên gán cho một loại file và được dùng để xác định nội dung thuộc kiểu nào để truyền dữ liệu và các ứng dụng dựa vào đó hành xử phù hợp</span></em>. Từ MIME type ta có thể xác định được loại file, vậy <em><span class="highlight-text red">từ một file làm sao xác định MIME type của nó?</span></em></p>
<p>Để xác định MIME type, chúng ta cần đọc nội dung của nó. Mỗi loại sẽ file có cách lưu trữ khác nhau, chẳng hạn như file ZIP có đặc tả như ở <a href="https://www.iana.org/assignments/media-types/application/zip">đây</a>. Nhưng vẫn có chung một số đặc điểm mà có thể dùng để nhận dạng.</p>
<p><strong>File Signature</strong> là những byte pattern được lưu ở vị trí bắt đầu file (hay còn gọi là <em>magic number</em> hay <em>magic bytes</em>), được dùng để xác định nội dung và định dạng của file. Bảng dưới đây liệt kê một vài File signature của một số định dạng phổ biến (<a href="https://en.wikipedia.org/wiki/List_of_file_signatures">tham khảo</a>).</p>
<table>
<thead>
<tr>
<th>Hex signature</th>
<th>ISO 8859-1</th>
<th>Offset</th>
<th>Extension</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>89 50 4E 47 0D 0A 1A 0A</code></td>
<td><code>‰PNG␍␊␚␊</code></td>
<td>0</td>
<td>png</td>
<td>Image encoded in the Portable Network Graphics format</td>
</tr>
<tr>
<td><code>EF BB BF</code></td>
<td><code>ï»¿</code></td>
<td>0</td>
<td>txt</td>
<td>UTF-8 byte order mark, commonly seen in text files.</td>
</tr>
<tr>
<td><code>25 50 44 46 2D</code></td>
<td><code>%PDF-</code></td>
<td>0</td>
<td>pdf</td>
<td>PDF document</td>
</tr>
<tr>
<td><code>66 74 79 70 69 73 6F 6D</code></td>
<td><code>ftypisom</code></td>
<td>4</td>
<td>mp4</td>
<td>ISO Base Media file (MPEG-4)</td>
</tr>
<tr>
<td><code>37 7A BC AF 27 1C</code></td>
<td>`7z¼¯'␜</td>
<td>0</td>
<td>7z</td>
<td>7-Zip File Format</td>
</tr>
</tbody>
</table>
<p>Ngoài việc xác định <em>File signature</em>, đôi khi còn phải xác định cả nội dung của file thì mới tìm được chính xác loại file. Ví dụ: Định dạng SVG thực chất là XML. Do đó để xác định được nó, ngoài việc phải đọc <em>magic number</em> để xác định được định dạng XML, còn cần phải đọc thêm nội dung bên trong mới xác định chính xác định dạng SVG.</p>
<p>Một số định dạng khác như <em>Apple iWork</em>, thực chất là một tập các file XML nằm bên trong một file Zip. Lúc này file Zip có nhiệm vụ làm container chứa các file XML và việc xác định trở nên khó hơn do phải giải nén nội dung bên trong.</p>
<h2 id="dùng-apache-tika-để-xác-định-mime-type">Dùng Apache Tika để xác định MIME Type</h2>
<p>Với các hệ thống Java, có thể dùng <a href="https://tika.apache.org/">Apache Tika</a> để trích xuất thông tin và xác định chính xác định dạng dữ liệu của file. Apache Tika xác định định dạng dữ liệu của file dựa vào nhiều tiêu chí:</p>
<ul>
<li><em>Magic number</em>: Tập các byte đầu của file.</li>
<li><em>File name extension</em>: Một phần dựa vào file extension.</li>
<li><em>Metadata</em> của file được download về từ Internet.</li>
<li>Xác định <em>container</em> và nội dung bên trong.</li>
</ul>
<p>Để dùng Tika trong <em>Maven project</em>, có thể thêm dependency vào <code>pom.xml</code>:</p>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.apache.tika&lt;/groupId&gt;
    &lt;artifactId&gt;tika-core&lt;/artifactId&gt;
    &lt;version&gt;2.1.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>Từ đây, chúng ta có thể viết thêm chức năng xác định đúng MIME type của một file khi upload lên hệ thống.</p>

  
    
  
  
    
  
  
  


<figure class="highlight java language-java">
  <figcaption>
    
      <span>FileUtils.java</span>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-java java"><code class="java">public class FileUtils {
    public static String getRealMimeType(MultipartFile file) {
        AutoDetectParser parser = new AutoDetectParser();
        Detector detector = parser.getDetector();
        try {
            Metadata metadata = new Metadata();
            TikaInputStream stream = TikaInputStream.get(file.getInputStream());
            MediaType mediaType = detector.detect(stream, metadata);
            return mediaType.toString();
        } catch (IOException e) {
            return MimeTypes.OCTET_STREAM;
        }
    }
}</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>

<p>Tạo thêm một API nữa dưới backend và sử dụng Tika để nhận dạng MIME Type.</p>
<pre><code class="language-java">@PostMapping(path = &quot;/check-real-type&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
public ResponseEntity&lt;Response&gt; checkRealType(@RequestPart MultipartFile file) {
    String mimeType = FileUtils.getRealMimeType(file);
    return ResponseEntity.ok(new Response(mimeType));
}
</code></pre>
<p>Sau đó, chỉnh sửa giao diện để upload file xuống backend sử dụng API vừa tạo rồi test lại với một số file.</p>


 
  
  
  
  
    
  
    
      
    
  

<div class="figure center" >
  
    <a class="fancybox" href="https://chidokun.github.io/images/post/software/mime-type-and-upload-file-problem/4.png" title="Kết quả test lại với real.png và fake.zip. Tika đã xác định đúng." data-fancybox-group="">
  
    <img class="fig-img" src="https://chidokun.github.io/images/post/software/mime-type-and-upload-file-problem/4.png" style="width: 100%;" alt="Kết quả test lại với real.png và fake.zip. Tika đã xác định đúng.">
  
    </a>
  
   
    <span class="caption">Kết quả test lại với real.png và fake.zip. Tika đã xác định đúng.</span>
  
</div>

<p>File <code>real.png</code> Tika đã xác định đúng MIME type. Với file <code>fake.zip</code>, Tika đã xác định đúng MIME type gốc của file là <code>image/jpeg</code> mặc dù đã được đổi tên thành <code>fake.zip</code>.</p>
<p>Có thể tham khảo danh sách các định dạng mà Tika đang hỗ trợ nhận dạng tại <a href="https://tika.apache.org/2.1.0/formats.html">đây</a>.</p>
<h1 id="tldr">TL;DR</h1>
<p>Các hệ thống backend khi nhận file upload nên xác thực lại kiểu của file được upload lên. Kiểm tra kiểu của file dựa vào MIME type do client xác định là chưa đủ vì sẽ có trường hợp file bị đổi extension để đánh lừa hệ thống. Mỗi loại file đều có cấu trúc khác nhau, với các hệ thống Java, có thể xác định chính xác kiểu của file dựa vào cấu trúc của nó dưới sự giúp đỡ của Apache Tika.</p>
<p>Xem source code ở đây: <a href="https://github.com/chidokun/mime-type-upload-example">https://github.com/chidokun/mime-type-upload-example</a></p>
<p><strong>References</strong></p>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types">MIME types (IANA media types)</a></li>
<li><a href="https://www.w3.org/TR/html401/interact/forms.html#h-17.13.4">Form Content-Type</a></li>
<li><a href="https://en.wikipedia.org/wiki/List_of_file_signatures">List of file signatures</a></li>
<li><a href="https://tika.apache.org/2.0.0/detection.html">Apache Tika - Content Detection</a></li>
</ul>

              

            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">THẺ ĐÁNH DẤU</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://chidokun.github.io/tags/backend/">backend</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://chidokun.github.io/2021/10/mime-type-and-upload-file-problem/en/" data-tooltip="MIME Type and Uploaded File Type Detection Problem" aria-label="Tiếp: MIME Type and Uploaded File Type Detection Problem">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">Tiếp</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://chidokun.github.io/2021/09/dijkstra-algorithm/" data-tooltip="Thuật toán Dijkstra: Tìm đường đi ngắn nhất" aria-label="Trước: Thuật toán Dijkstra: Tìm đường đi ngắn nhất">
              
                  <span class="hide-xs hide-sm text-small icon-mr">Trước</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Chia sẻ bài viết này">
            <i class="fa fa-share-alt" aria-hidden="true"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://chidokun.github.io/2021/09/mime-type-and-upload-file-problem/" title="Chia sẻ với %s Facebook" aria-label="Chia sẻ với %s Facebook">
              <i class="fab fa-facebook" aria-hidden="true"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://chidokun.github.io/2021/09/mime-type-and-upload-file-problem/" title="Chia sẻ với %s Twitter" aria-label="Chia sẻ với %s Twitter">
              <i class="fab fa-twitter" aria-hidden="true"></i>
            </a>
          </li>
        
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#" aria-label="Trở lại đầu trang">
        
          <i class="fa fa-list" aria-hidden="true"></i>
        </a>
      </li>
    </ul>
  
</div>

            
  
    <section id="comments">
        
        <h2 class="title"><a href="#comments">Bình luận</a></h2>
        <form id="comment-form" class="post-new-comment" method="post" action="https://chidokun-blog-comment.herokuapp.com/v3/entry/github/chidokun/chidokun.github.io/master/comments">
            
            
            <div class="comment-box">
                <textarea name="fields[comment]" class="comment-input-control comment-input-animated" placeholder="Comment (markdown is accepted) *" required rows="3"></textarea>
                <div class="comment-box-tail">
                    <input type="hidden" name="options[redirect]" value="https://chidokun.github.io/2021/09/mime-type-and-upload-file-problem/#comment-submitted">
                    <input type="hidden" name="options[slug]" value="mime-type-and-upload-file-problem">
                    <input type="text" name="fields[name]" class="post-comment-field" placeholder="Name *" required/>
                    <input type="email" name="fields[email]" class="post-comment-field" placeholder="Email address (will not be public) *" required/>
                    <input type="hidden" id="comment-parent" name="fields[reply_to]" value="">
                    <input type="submit" class="btn btn--primary comment-buttons btn--comment" value="BÌNH LUẬN">
                </div>
            </div>
            
            
        </form>
        <section class="staticman-comments post-comments">
            
            
            
    
            
            
    
            
    
            
    
        </section>

    <div id="comment-submitted" class="dialog">
        <h3>Cảm ơn bạn</h3>
        <p>Your comment has been submitted and will be published once it has been approved. &#128522;</p>

        <p><a href="#" class="btn btn--primary comment-buttons ok">OK</a></p>
    </div>

    
</section>

  
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2021 <a href="https://github.com/chidokun">Nguyễn Tuấn</a>. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://chidokun.github.io/2021/10/mime-type-and-upload-file-problem/en/" data-tooltip="MIME Type and Uploaded File Type Detection Problem" aria-label="Tiếp: MIME Type and Uploaded File Type Detection Problem">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">Tiếp</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://chidokun.github.io/2021/09/dijkstra-algorithm/" data-tooltip="Thuật toán Dijkstra: Tìm đường đi ngắn nhất" aria-label="Trước: Thuật toán Dijkstra: Tìm đường đi ngắn nhất">
              
                  <span class="hide-xs hide-sm text-small icon-mr">Trước</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Chia sẻ bài viết này">
            <i class="fa fa-share-alt" aria-hidden="true"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://chidokun.github.io/2021/09/mime-type-and-upload-file-problem/" title="Chia sẻ với %s Facebook" aria-label="Chia sẻ với %s Facebook">
              <i class="fab fa-facebook" aria-hidden="true"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://chidokun.github.io/2021/09/mime-type-and-upload-file-problem/" title="Chia sẻ với %s Twitter" aria-label="Chia sẻ với %s Twitter">
              <i class="fab fa-twitter" aria-hidden="true"></i>
            </a>
          </li>
        
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#" aria-label="Trở lại đầu trang">
        
          <i class="fa fa-list" aria-hidden="true"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fchidokun.github.io%2F2021%2F09%2Fmime-type-and-upload-file-problem%2F" aria-label="Chia sẻ với %s Facebook">
          <i class="fab fa-facebook" aria-hidden="true"></i><span>Chia sẻ với Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fchidokun.github.io%2F2021%2F09%2Fmime-type-and-upload-file-problem%2F" aria-label="Chia sẻ với %s Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Chia sẻ với Twitter</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.gravatar.com/avatar/e09926cb6ae66048297c59c891a02e50?s=110" alt="Ảnh đại diện" />
    
    <h4 id="about-card-name">Nguyễn Tuấn</h4>
    
      <div id="about-card-bio">A guy with passionate at the code</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Software Engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        Saigon, Vietnam
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://chidokun.github.io/images/background.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://chidokun.github.io/js/script-8lglxdix2nqhalxxm2bujhkcc8cctdrd5o5axonwhfzx2zqrer5facyn8.min.js"></script>


  
    <script async crossorigin="anonymous" defer integrity="sha512-28oDiQZGKUVN6wQ7PSLPNipOcmkCALXKwOi7bnkyFf8QiMZQxG9EQoy/iiNx6Zxj2cG2SbVa4dXKigQhu7GiFw==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/yaml.min.js"></script>
  

  
    <script crossorigin="anonymous" integrity="sha384-jmxIlussZWB7qCuB+PgKG1uLjjxbVVIayPJwi6cG6Zb4YKq0JIw+OMnkkEC7kYCq" src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.js"></script>
  

  
    <script crossorigin="anonymous" integrity="sha384-IiI65aU9ZYub2MY9zhtKd1H2ps7xxf+eb2YFG9lX6uRqpXCvBTOidPRCXCrQ++Uc" src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/contrib/auto-render.min.js"></script>
  

  
    <script src="https://chidokun.github.io/js/main.js"></script>
  


<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

